<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nizebook - Enhanced Digital Book Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-bg: #F5F0E6;
            --secondary-bg: #FFFFFF;
            --accent-color: #FFD700;
            --text-primary: #1B1B1B;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --hover-bg: #F3F4F6;
            --page-bg: #FFF9E6;
        }

        [data-theme="dark"] {
            --primary-bg: #1B1B1B;
            --secondary-bg: #2D2D2D;
            --accent-color: #D4AF37;
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
            --border-color: #374151;
            --hover-bg: #374151;
            --page-bg: #2A2A2A;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            display: flex;
            min-height: 100vh;
        }

        .card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .book-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.15);
        }

        .page-transition {
            animation: pageFlip 0.6s ease-in-out;
        }

        @keyframes pageFlip {
            0% { transform: rotateY(0deg); opacity: 1; }
            50% { transform: rotateY(-90deg); opacity: 0.5; }
            100% { transform: rotateY(0deg); opacity: 1; }
        }

        .modal {
            backdrop-filter: blur(4px);
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent-color) 0%, #D4AF37 100%);
        }

        .reading-progress {
            background: linear-gradient(90deg, #10B981 0%, var(--accent-color) 100%);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--border-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

        .book-cover-placeholder {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
        }

        .chapter-item {
            transition: all 0.2s ease;
        }

        .chapter-item:hover {
            background-color: var(--hover-bg);
        }

        .prompt-message {
            text-align: center;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .mobile-hidden {
                display: none;
            }
            .sidebar {
                width: 60px;
            }
            .dictionary-panel {
                width: 100%;
                max-width: none;
                position: static;
            }
            .reader-container {
                flex-direction: column;
            }
        }

        .sidebar {
            width: 80px;
            border-right: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
        }

        .chapter-nav {
            max-width: 200px;
            border-left: 1px solid var(--border-color);
        }

        .chapter-nav-item.active {
            background-color: var(--accent-color);
            color: white;
        }

        .dictionary-panel {
            width: 300px;
            border-left: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .reader-container {
            display: flex;
            flex: 1;
            gap: 1rem;
        }

        .reader-content {
            flex: 1;
            max-width: 4xl;
            margin: 0 auto;
        }

        .recording-controls {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        button {
            border-radius: 10px;
        }

        #book-page {
            background-color: var(--page-bg);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar card fixed top-0 left-0 h-full p-4 flex flex-col items-center space-y-6 z-50">
        <div class="flex items-center justify-center mb-6">
            <i class="fas fa-book-open text-3xl" style="color: var(--accent-color);"></i>
        </div>
        <button onclick="showSection('home')" class="nav-item p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" id="nav-home">
            <i class="fas fa-home text-lg"></i>
        </button>
        <button onclick="showSection('library')" class="nav-item p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" id="nav-library">
            <i class="fas fa-book text-lg"></i>
        </button>
        <button onclick="showSection('audiobooks')" class="nav-item p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" id="nav-audiobooks">
            <i class="fas fa-headphones text-lg"></i>
        </button>
        <button onclick="showSection('uploaded-audiobooks')" class="nav-item p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" id="nav-uploaded-audiobooks">
            <i class="fas fa-microphone text-lg"></i>
        </button>
        <button onclick="toggleTheme()" class="p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 ml-20 md:ml-24 p-4">
        <!-- Home Section -->
        <div id="home-section" class="section">
            <div class="card rounded-lg p-6 mb-8 bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                <h2 class="text-2xl font-bold mb-2">Welcome to Nizebook!</h2>
                <p class="opacity-90 mb-4">Start your reading journey</p>
                <button onclick="showCreateBookModal()" class="p-3 bg-white text-blue-600 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>Create New Book
                </button>
            </div>
            <div class="mb-8">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-bookmark mr-2"></i>
                    Continue Reading
                </h3>
                <div id="continue-reading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="card rounded-lg p-4 text-center">
                        <i class="fas fa-book-open text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500">No books in progress</p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600" id="stat-total-books">0</div>
                    <div class="text-sm text-gray-500">Total Books</div>
                </div>
                <div class="card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600" id="stat-completed">0</div>
                    <div class="text-sm text-gray-500">Completed</div>
                </div>
                <div class="card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="stat-in-progress">0</div>
                    <div class="text-sm text-gray-500">In Progress</div>
                </div>
                <div class="card rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600" id="stat-reading-time">0h</div>
                    <div class="text-sm text-gray-500">Reading Time</div>
                </div>
            </div>
            <div class="prompt-message text-center text-gray-500 mt-4">
                <p>Select a book to start reading or create a new book.</p>
                <button onclick="showSection('library')" class="mt-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
                    <i class="fas fa-book"></i> Go to Library
                </button>
            </div>
        </div>

        <!-- Library Section -->
        <div id="library-section" class="section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">My Library</h2>
                <button onclick="showCreateBookModal()" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="books-grid" class="flex justify-center"></div>
            <div id="library-pagination" class="pagination-controls"></div>
        </div>

        <!-- Audiobooks Section -->
        <div id="audiobooks-section" class="section hidden">
            <h2 class="text-2xl font-bold mb-6">Audiobooks</h2>
            <div id="audiobooks-grid" class="flex justify-center"></div>
            <div id="audiobooks-pagination" class="pagination-controls"></div>
        </div>

        <!-- Uploaded Audiobooks Section -->
        <div id="uploaded-audiobooks-section" class="section hidden">
            <h2 class="text-2xl font-bold mb-6">Uploaded Audiobooks</h2>
            <div id="uploaded-audiobooks-grid" class="flex justify-center"></div>
            <div id="uploaded-audiobooks-pagination" class="pagination-controls"></div>
        </div>

        <!-- Book Reader -->
        <div id="reader-section" class="section hidden reader-container">
            <div id="chapter-nav" class="chapter-nav card p-4">
                <h3 class="text-lg font-semibold mb-4">Chapters</h3>
                <div id="chapter-list" class="space-y-2"></div>
            </div>
            <div class="reader-content">
                <div class="card rounded-lg p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
                    <button onclick="goBackToLibrary()" class="p-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                <div class="card rounded-lg p-8 mb-6 min-h-screen" id="book-page">
                    <div class="text-center mb-6">
                        <h1 class="text-2xl font-bold mb-2" id="book-title"></h1>
                        <p class="text-gray-600" id="chapter-title"></p>
                    </div>
                    <div class="prose dark:prose-invert max-w-none" id="page-content"></div>
                    <div class="text-center mt-8 text-sm text-gray-500" id="page-info">
                        Page 1 of 1
                    </div>
                </div>
                <div class="flex justify-between items-center mb-6">
                    <button onclick="previousPage()" id="prev-btn" class="p-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors disabled:opacity-50">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-500" id="progress-text">0%</span>
                        <div class="w-32 h-2 bg-gray-200 dark:bg-gray-700 rounded-full">
                            <div class="h-2 reading-progress rounded-full" style="width: 0%" id="progress-bar"></div>
                        </div>
                    </div>
                    <button onclick="nextPage()" id="next-btn" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="recording-controls card rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Record Audio Note</h3>
                    <div class="flex justify-center items-center space-x-4">
                        <button id="note-record-btn" onclick="toggleNoteRecording()" class="p-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <span id="note-recording-status" class="text-sm text-gray-500"></span>
                    </div>
                </div>
            </div>
            <div id="dictionary-panel" class="dictionary-panel card p-4">
                <h3 class="text-lg font-semibold mb-4">Dictionary & Notes</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Search Dictionary</label>
                        <div class="flex space-x-2">
                            <input type="text" id="dictionary-input" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" placeholder="Enter a word">
                            <button onclick="searchDictionary()" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="dictionary-results" class="mt-2 max-h-40 overflow-y-auto"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Add Text Note</label>
                        <textarea id="reader-note-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 h-20" placeholder="Type your note here"></textarea>
                        <button onclick="saveReaderNote()" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            Save Note
                        </button>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium mb-2">Notes</h4>
                        <div id="notes-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium mb-2">Audio Notes</h4>
                        <div id="audio-notes-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Book Modal -->
        <div id="create-book-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
            <div class="card rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Create New Book</h3>
                    <button onclick="closeCreateBookModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="create-book-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Book Title</label>
                        <input type="text" id="book-title-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Description</label>
                        <textarea id="book-description-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 h-20"></textarea>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="book-is-audiobook" class="mr-2">
                            <span class="text-sm font-medium">Is Audiobook</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Book Cover</label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                            <input type="file" id="book-cover-input" accept="image/*" class="hidden" onchange="previewCover(this)">
                            <button type="button" onclick="document.getElementById('book-cover-input').click()" class="text-blue-600 hover:text-blue-700">
                                <i class="fas fa-upload text-2xl mb-2"></i>
                                <p>Click to upload cover image</p>
                            </button>
                            <div id="cover-preview" class="hidden mt-4">
                                <img id="cover-preview-img" class="w-24 h-32 object-cover mx-auto rounded">
                            </div>
                        </div>
                    </div>
                    <div id="audiobook-upload" class="hidden">
                        <label class="block text-sm font-medium mb-2">Audiobook File</label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                            <input type="file" id="book-audio-input" accept="audio/mp3,audio/webm" class="hidden" onchange="previewAudio(this)">
                            <button type="button" onclick="document.getElementById('book-audio-input').click()" class="text-blue-600 hover:text-blue-700">
                                <i class="fas fa-file-audio text-2xl mb-2"></i>
                                <p>Click to upload audiobook file</p>
                                <p class="text-sm text-gray-500">Supports MP3, WEBM</p>
                            </button>
                            <div id="audio-preview" class="hidden mt-4">
                                <p id="audio-preview-name" class="text-sm"></p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeCreateBookModal()" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            Create Book
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Chapter Modal -->
        <div id="add-chapter-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
            <div class="card rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Add Chapter</h3>
                    <button onclick="closeAddChapterModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="add-chapter-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Chapter Title</label>
                        <input type="text" id="chapter-title-input" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Content Files</label>
                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                            <input type="file" id="chapter-files-input" accept=".txt,.pdf,.docx" multiple class="hidden" onchange="previewFiles(this)">
                            <button type="button" onclick="document.getElementById('chapter-files-input').click()" class="text-blue-600 hover:text-blue-700">
                                <i class="fas fa-file-upload text-2xl mb-2"></i>
                                <p>Click to upload content files</p>
                                <p class="text-sm text-gray-500">Supports TXT, PDF, DOCX</p>
                            </button>
                            <div id="files-preview" class="hidden mt-4 space-y-2"></div>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeAddChapterModal()" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            Add Chapter
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Save Note Recording Modal -->
        <div id="save-note-recording-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal z-50 flex items-center justify-center p-4">
            <div class="card rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Save Audio Note</h3>
                    <button onclick="closeSaveNoteRecordingModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="save-note-recording-form" class="space-y-4">
                    <p class="text-sm text-gray-500">This audio note will be saved for the current book, chapter, and page.</p>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeSaveNoteRecordingModal()" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>

    <script>
        // Global variables
        let books = JSON.parse(localStorage.getItem('nizebook_books')) || [];
        let uploadedAudiobooks = JSON.parse(localStorage.getItem('nizebook_uploaded_audiobooks')) || [];
        let readingProgress = JSON.parse(localStorage.getItem('nizebook_progress')) || {};
        let notes = JSON.parse(localStorage.getItem('nizebook_notes')) || [];
        let currentBook = null;
        let currentChapterIndex = 0;
        let currentPageIndex = 0;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isNoteRecording = false;
        let recordedAudioData = null;
        let currentLibraryPage = 0;
        let currentAudiobookPage = 0;
        let currentUploadedAudiobookPage = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            loadTheme();
            updateStats();
            displayBooks();
            displayContinueReading();
            displayAudiobooks();
            displayUploadedAudiobooks();
            showSection('home');
            checkMediaRecorderSupport();
            const audiobookCheckbox = document.getElementById('book-is-audiobook');
            if (audiobookCheckbox) {
                audiobookCheckbox.addEventListener('change', toggleAudiobookUpload);
            }
        }

        // Theme management
        function loadTheme() {
            const theme = localStorage.getItem('nizebook_theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('nizebook_theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            const section = document.getElementById(`${sectionName}-section`);
            if (section) {
                section.classList.remove('hidden');
            }
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'dark:bg-blue-900');
            });
            const navItem = document.getElementById(`nav-${sectionName}`);
            if (navItem) {
                navItem.classList.add('bg-blue-100', 'dark:bg-blue-900');
            }
            const chapterNav = document.getElementById('chapter-nav');
            const dictionaryPanel = document.getElementById('dictionary-panel');
            if (sectionName !== 'reader') {
                if (chapterNav) chapterNav.classList.add('hidden');
                if (dictionaryPanel) dictionaryPanel.classList.add('hidden');
            } else {
                if (chapterNav) chapterNav.classList.remove('hidden');
                if (dictionaryPanel) dictionaryPanel.classList.remove('hidden');
            }
            if (sectionName === 'library') {
                currentLibraryPage = 0;
                displayBooks();
            } else if (sectionName === 'audiobooks') {
                currentAudiobookPage = 0;
                displayAudiobooks();
            } else if (sectionName === 'uploaded-audiobooks') {
                currentUploadedAudiobookPage = 0;
                displayUploadedAudiobooks();
            }
            displayNotes();
        }

        // Stats management
        function updateStats() {
            const totalBooks = books.length + uploadedAudiobooks.length;
            const completedBooks = Object.values(readingProgress).filter(p => p.completed).length;
            const inProgressBooks = Object.keys(readingProgress).length - completedBooks;
            const totalPages = books.reduce((sum, book) => sum + (book.chapters ? book.chapters.reduce((chSum, ch) => chSum + ch.pages.length, 0) : 0), 0);
            const readingTime = Math.floor(totalPages * 2 / 60);

            const totalBooksEl = document.getElementById('stat-total-books');
            const completedEl = document.getElementById('stat-completed');
            const inProgressEl = document.getElementById('stat-in-progress');
            const readingTimeEl = document.getElementById('stat-reading-time');

            if (totalBooksEl) totalBooksEl.textContent = totalBooks;
            if (completedEl) completedEl.textContent = completedBooks;
            if (inProgressEl) inProgressEl.textContent = inProgressBooks;
            if (readingTimeEl) readingTimeEl.textContent = readingTime + 'h';
        }

        // Book management
        function displayBooks() {
            const grid = document.getElementById('books-grid');
            const pagination = document.getElementById('library-pagination');
            if (!grid || !pagination) return;
            if (books.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-book-open text-6xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-500 mb-2">No books yet</h3>
                        <p class="text-gray-400 mb-4">Create your first book to get started</p>
                        <button onclick="showCreateBookModal()" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
                pagination.innerHTML = '';
                return;
            }
            if (currentLibraryPage >= books.length) {
                currentLibraryPage = books.length - 1;
            }
            if (currentLibraryPage < 0) {
                currentLibraryPage = 0;
            }
            const book = books[currentLibraryPage];
            grid.innerHTML = `
                <div class="book-card card rounded-lg overflow-hidden max-w-md">
                    <div class="aspect-w-3 aspect-h-4 relative">
                        ${book.cover ? 
                            `<img src="${book.cover}" alt="${book.title}" class="w-full h-48 object-cover">` :
                            `<div class="w-full h-48 book-cover-placeholder flex items-center justify-center">
                                <i class="fas fa-book text-4xl text-white"></i>
                            </div>`
                        }
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-sm mb-1 truncate" title="${book.title}">${book.title}</h3>
                        <p class="text-xs text-gray-500 mb-2 line-clamp-2">${book.description || 'No description'}</p>
                        <p class="text-xs text-gray-400 mb-3">${book.chapters ? book.chapters.length : 0} chapters</p>
                        <div class="flex space-x-2">
                            <button onclick="openBook(${currentLibraryPage})" class="flex-1 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-colors">
                                <i class="fas fa-book-open"></i>
                            </button>
                            <button onclick="showAddChapterModal(${currentLibraryPage})" class="p-2 border border-gray-300 dark:border-gray-600 rounded text-xs hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            pagination.innerHTML = `
                <div class="flex items-center space-x-4">
                    <button onclick="previousLibraryPage()" class="p-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors ${currentLibraryPage === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentLibraryPage === 0 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="text-sm text-gray-500">Book ${currentLibraryPage + 1} of ${books.length}</span>
                    <button onclick="nextLibraryPage()" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors ${currentLibraryPage === books.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentLibraryPage === books.length - 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
        }

        function previousLibraryPage() {
            if (currentLibraryPage > 0) {
                currentLibraryPage--;
                displayBooks();
            }
        }

        function nextLibraryPage() {
            if (currentLibraryPage < books.length - 1) {
                currentLibraryPage++;
                displayBooks();
            }
        }

        function displayAudiobooks() {
            const grid = document.getElementById('audiobooks-grid');
            const pagination = document.getElementById('audiobooks-pagination');
            if (!grid || !pagination) return;
            const audiobookList = books.filter(book => book.audio);
            if (audiobookList.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-headphones text-6xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-500 mb-2">No audiobooks yet</h3>
                        <p class="text-gray-400 mb-4">Add chapters with audio to existing books</p>
                    </div>
                `;
                pagination.innerHTML = '';
                return;
            }
            if (currentAudiobookPage >= audiobookList.length) {
                currentAudiobookPage = audiobookList.length - 1;
            }
            if (currentAudiobookPage < 0) {
                currentAudiobookPage = 0;
            }
            const book = audiobookList[currentAudiobookPage];
            const bookIndex = books.findIndex(b => b.id === book.id);
            grid.innerHTML = `
                <div class="book-card card rounded-lg overflow-hidden max-w-md">
                    <div class="aspect-w-3 aspect-h-4 relative">
                        ${book.cover ? 
                            `<img src="${book.cover}" alt="${book.title}" class="w-full h-48 object-cover">` :
                            `<div class="w-full h-48 book-cover-placeholder flex items-center justify-center">
                                <i class="fas fa-book text-4xl text-white"></i>
                            </div>`
                        }
                        <div class="absolute top-2 left-2 bg-purple-500 text-white px-2 py-1 rounded-full text-xs">
                            <i class="fas fa-headphones"></i>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-sm mb-1 truncate" title="${book.title}">${book.title}</h3>
                        <p class="text-xs text-gray-500 mb-2 line-clamp-2">${book.description || 'No description'}</p>
                        <div class="flex space-x-2">
                            <button onclick="playAudiobook(${bookIndex})" class="flex-1 p-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs transition-colors">
                                <i class="fas fa-play"></i> Play
                            </button>
                        </div>
                    </div>
                </div>
            `;
            pagination.innerHTML = `
                <div class="flex items-center space-x-4">
                    <button onclick="previousAudiobookPage()" class="p-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors ${currentAudiobookPage === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentAudiobookPage === 0 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="text-sm text-gray-500">Audiobook ${currentAudiobookPage + 1} of ${audiobookList.length}</span>
                    <button onclick="nextAudiobookPage()" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors ${currentAudiobookPage === audiobookList.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentAudiobookPage === audiobookList.length - 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
        }

        function previousAudiobookPage() {
            if (currentAudiobookPage > 0) {
                currentAudiobookPage--;
                displayAudiobooks();
            }
        }

        function nextAudiobookPage() {
            const audiobookList = books.filter(book => book.audio);
            if (currentAudiobookPage < audiobookList.length - 1) {
                currentAudiobookPage++;
                displayAudiobooks();
            }
        }

        function displayUploadedAudiobooks() {
            const grid = document.getElementById('uploaded-audiobooks-grid');
            const pagination = document.getElementById('uploaded-audiobooks-pagination');
            if (!grid || !pagination) return;
            if (uploadedAudiobooks.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-microphone text-6xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-500 mb-2">No uploaded audiobooks yet</h3>
                        <p class="text-gray-400 mb-4">Create a new audiobook to get started</p>
                        <button onclick="showCreateBookModal()" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
                pagination.innerHTML = '';
                return;
            }
            if (currentUploadedAudiobookPage >= uploadedAudiobooks.length) {
                currentUploadedAudiobookPage = uploadedAudiobooks.length - 1;
            }
            if (currentUploadedAudiobookPage < 0) {
                currentUploadedAudiobookPage = 0;
            }
            const audiobook = uploadedAudiobooks[currentUploadedAudiobookPage];
            grid.innerHTML = `
                <div class="book-card card rounded-lg overflow-hidden max-w-md">
                    <div class="aspect-w-3 aspect-h-4 relative">
                        ${audiobook.cover ? 
                            `<img src="${audiobook.cover}" alt="${audiobook.title}" class="w-full h-48 object-cover">` :
                            `<div class="w-full h-48 book-cover-placeholder flex items-center justify-center">
                                <i class="fas fa-book text-4xl text-white"></i>
                            </div>`
                        }
                        <div class="absolute top-2 left-2 bg-purple-500 text-white px-2 py-1 rounded-full text-xs">
                            <i class="fas fa-microphone"></i>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-sm mb-1 truncate" title="${audiobook.title}">${audiobook.title}</h3>
                        <p class="text-xs text-gray-500 mb-2 line-clamp-2">${audiobook.description || 'No description'}</p>
                        <div class="flex space-x-2">
                            <button onclick="playUploadedAudiobook(${currentUploadedAudiobookPage})" class="flex-1 p-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-xs transition-colors">
                                <i class="fas fa-play"></i> Play
                            </button>
                        </div>
                    </div>
                </div>
            `;
            pagination.innerHTML = `
                <div class="flex items-center space-x-4">
                    <button onclick="previousUploadedAudiobookPage()" class="p-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors ${currentUploadedAudiobookPage === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentUploadedAudiobookPage === 0 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="text-sm text-gray-500">Audiobook ${currentUploadedAudiobookPage + 1} of ${uploadedAudiobooks.length}</span>
                    <button onclick="nextUploadedAudiobookPage()" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors ${currentUploadedAudiobookPage === uploadedAudiobooks.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentUploadedAudiobookPage === uploadedAudiobooks.length - 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            `;
        }

        function previousUploadedAudiobookPage() {
            if (currentUploadedAudiobookPage > 0) {
                currentUploadedAudiobookPage--;
                displayUploadedAudiobooks();
            }
        }

        function nextUploadedAudiobookPage() {
            if (currentUploadedAudiobookPage < uploadedAudiobooks.length - 1) {
                currentUploadedAudiobookPage++;
                displayUploadedAudiobooks();
            }
        }

        function playUploadedAudiobook(index) {
            const audiobook = uploadedAudiobooks[index];
            if (audiobook.audio) {
                try {
                    const audio = new Audio(audiobook.audio);
                    audio.play();
                    showToast('Playing audiobook: ' + audiobook.title);
                } catch (err) {
                    console.error('Error playing uploaded audiobook:', err);
                    showToast('Failed to play audiobook', 'error');
                }
            } else {
                showToast('No audio available for this audiobook', 'error');
            }
        }

        function playAudiobook(bookIndex) {
            const book = books[bookIndex];
            if (book.audio) {
                try {
                    const audio = new Audio(book.audio);
                    audio.play();
                    showToast('Playing audiobook: ' + book.title);
                } catch (err) {
                    console.error('Error playing audiobook:', err);
                    showToast('Failed to play audiobook', 'error');
                }
            } else {
                showToast('No audio available for this book', 'error');
            }
        }

        function displayContinueReading() {
            const container = document.getElementById('continue-reading');
            if (!container) return;
            const inProgressBooks = books.filter(book => {
                const progress = readingProgress[book.id];
                return progress && !progress.completed && (progress.currentChapter > 0 || progress.currentPage > 0);
            });
            if (inProgressBooks.length === 0) {
                container.innerHTML = `
                    <div class="card rounded-lg p-6 text-center">
                        <i class="fas fa-book-open text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500">No books in progress</p>
                        <button onclick="showSection('library')" class="mt-2 p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
                            <i class="fas fa-book"></i>
                        </button>
                    </div>
                `;
                return;
            }
            container.innerHTML = inProgressBooks.map((book, index) => {
                const progress = readingProgress[book.id];
                const bookIndex = books.findIndex(b => b.id === book.id);
                return `
                    <div class="book-card card rounded-lg p-4 flex items-center space-x-4">
                        <div class="w-12 h-16 flex-shrink-0">
                            ${book.cover ? 
                                `<img src="${book.cover}" alt="${book.title}" class="w-full h-full object-cover rounded">` :
                                `<div class="w-full h-full book-cover-placeholder rounded flex items-center justify-center">
                                    <i class="fas fa-book text-white"></i>
                                </div>`
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-sm truncate">${book.title}</h4>
                            <p class="text-xs text-gray-500">Chapter ${progress.currentChapter + 1}, Page ${progress.currentPage + 1}</p>
                        </div>
                        <button onclick="continueReading(${bookIndex})" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-colors">
                            <i class="fas fa-book-open"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function continueReading(bookIndex) {
            const book = books[bookIndex];
            const progress = readingProgress[book.id] || { currentChapter: 0, currentPage: 0 };
            currentBook = book;
            currentChapterIndex = progress.currentChapter;
            currentPageIndex = progress.currentPage;
            showBookReader();
        }

        // Book creation
        function showCreateBookModal() {
            const modal = document.getElementById('create-book-modal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeCreateBookModal() {
            const modal = document.getElementById('create-book-modal');
            const form = document.getElementById('create-book-form');
            const coverPreview = document.getElementById('cover-preview');
            const audioPreview = document.getElementById('audio-preview');
            const audiobookUpload = document.getElementById('audiobook-upload');
            const audiobookCheckbox = document.getElementById('book-is-audiobook');
            if (modal) modal.classList.add('hidden');
            if (form) form.reset();
            if (coverPreview) coverPreview.classList.add('hidden');
            if (audioPreview) audioPreview.classList.add('hidden');
            if (audiobookUpload) audiobookUpload.classList.add('hidden');
            if (audiobookCheckbox) audiobookCheckbox.checked = false;
        }

        function previewCover(input) {
            const preview = document.getElementById('cover-preview');
            const img = document.getElementById('cover-preview-img');
            if (input.files && input.files[0] && preview && img) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewAudio(input) {
            const preview = document.getElementById('audio-preview');
            const name = document.getElementById('audio-preview-name');
            if (input.files && input.files[0] && preview && name) {
                name.textContent = input.files[0].name;
                preview.classList.remove('hidden');
            }
        }

        function toggleAudiobookUpload() {
            const audiobookUpload = document.getElementById('audiobook-upload');
            const isAudiobook = document.getElementById('book-is-audiobook');
            if (audiobookUpload && isAudiobook) {
                audiobookUpload.classList.toggle('hidden', !isAudiobook.checked);
            }
        }

        document.getElementById('create-book-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const titleInput = document.getElementById('book-title-input');
            const descriptionInput = document.getElementById('book-description-input');
            const coverInput = document.getElementById('book-cover-input');
            const isAudiobook = document.getElementById('book-is-audiobook');
            const audioInput = document.getElementById('book-audio-input');
            if (!titleInput) return;

            const title = titleInput.value.trim();
            const description = descriptionInput ? descriptionInput.value.trim() : '';
            const coverFile = coverInput?.files[0];
            const audioFile = audioInput?.files[0];
            const isAudiobookChecked = isAudiobook?.checked;

            if (!title) {
                showToast('Please enter a book title', 'error');
                return;
            }

            if (isAudiobookChecked && !audioFile) {
                showToast('Please upload an audio file for the audiobook', 'error');
                return;
            }

            const item = {
                id: Date.now().toString(),
                title: title,
                description: description,
                cover: null,
                audio: null,
                chapters: isAudiobookChecked ? [] : [{
                    id: Date.now().toString(),
                    title: 'Introduction',
                    pages: [{
                        id: Date.now().toString(),
                        content: `Welcome to "${title}". Add chapters to start reading.`,
                        pageNumber: 1
                    }],
                    createdAt: new Date().toISOString()
                }],
                createdAt: new Date().toISOString()
            };

            function addItemAndOpenReader() {
                if (isAudiobookChecked) {
                    uploadedAudiobooks.push(item);
                    localStorage.setItem('nizebook_uploaded_audiobooks', JSON.stringify(uploadedAudiobooks));
                    displayUploadedAudiobooks();
                    closeCreateBookModal();
                    showToast('Audiobook created successfully!');
                } else {
                    books.push(item);
                    localStorage.setItem('nizebook_books', JSON.stringify(books));
                    currentBook = item;
                    currentChapterIndex = 0;
                    currentPageIndex = 0;
                    showBookReader();
                    closeCreateBookModal();
                    showToast('Book created successfully!');
                }
                updateStats();
                displayBooks();
                displayContinueReading();
            }

            function processAudioFile() {
                if (audioFile && isAudiobookChecked) {
                    const audioReader = new FileReader();
                    audioReader.onload = function(e) {
                        item.audio = e.target.result;
                        addItemAndOpenReader();
                    };
                    audioReader.onerror = function() {
                        showToast('Failed to read audio file', 'error');
                        addItemAndOpenReader();
                    };
                    audioReader.readAsDataURL(audioFile);
                } else {
                    addItemAndOpenReader();
                }
            }

            if (coverFile) {
                const coverReader = new FileReader();
                coverReader.onload = function(e) {
                    item.cover = e.target.result;
                    processAudioFile();
                };
                coverReader.onerror = function() {
                    showToast('Failed to read cover image', 'error');
                    processAudioFile();
                };
                coverReader.readAsDataURL(coverFile);
            } else {
                processAudioFile();
            }
        });

        // Chapter management
        function showAddChapterModal(bookIndex) {
            window.currentBookIndex = bookIndex;
            const modal = document.getElementById('add-chapter-modal');
            if (modal) modal.classList.remove('hidden');
        }

        function closeAddChapterModal() {
            const modal = document.getElementById('add-chapter-modal');
            const form = document.getElementById('add-chapter-form');
            const filesPreview = document.getElementById('files-preview');
            if (modal) modal.classList.add('hidden');
            if (form) form.reset();
            if (filesPreview) filesPreview.classList.add('hidden');
        }

        function previewFiles(input) {
            const preview = document.getElementById('files-preview');
            if (input.files && input.files.length > 0 && preview) {
                preview.innerHTML = Array.from(input.files).map(file => `
                    <div class="flex items-center space-x-2 p-2 bg-gray-100 dark:bg-gray-700 rounded">
                        <i class="fas fa-file-alt"></i>
                        <span class="text-sm truncate">${file.name}</span>
                        <span class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)}KB</span>
                    </div>
                `).join('');
                preview.classList.remove('hidden');
            }
        }

        document.getElementById('add-chapter-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const titleInput = document.getElementById('chapter-title-input');
            const filesInput = document.getElementById('chapter-files-input');
            if (!titleInput) return;

            const title = titleInput.value.trim();
            const files = filesInput?.files;

            if (!title) {
                showToast('Please enter a chapter title', 'error');
                return;
            }

            const chapter = {
                id: Date.now().toString(),
                title: title,
                pages: [],
                createdAt: new Date().toISOString()
            };

            function processChapterContent(content) {
                chapter.pages = splitContentIntoPages(content);
                books[window.currentBookIndex].chapters.push(chapter);
                saveData();
                updateStats();
                displayBooks();
                if (currentBook && currentBook.id === books[window.currentBookIndex].id) {
                    displayChapterNav();
                    if (currentChapterIndex >= books[window.currentBookIndex].chapters.length - 1) {
                        currentChapterIndex = books[window.currentBookIndex].chapters.length - 1;
                        currentPageIndex = 0;
                        displayCurrentPage();
                    }
                }
                closeAddChapterModal();
                showToast('Chapter added successfully!');
            }

            let allContent = '';

            if (files && files.length > 0) {
                let processedFiles = 0;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        allContent += `Content from ${file.name}:\n${file.type === 'application/pdf' ? 'Extracted PDF content (placeholder)' : e.target.result}\n\n`;
                        processedFiles++;
                        if (processedFiles === files.length) {
                            processChapterContent(allContent);
                        }
                    };
                    reader.onerror = function() {
                        showToast(`Failed to read file: ${file.name}`, 'error');
                        processedFiles++;
                        if (processedFiles === files.length) {
                            processChapterContent(allContent);
                        }
                    };
                    reader.readAsText(file);
                });
            } else {
                chapter.pages = [{
                    id: Date.now().toString(),
                    content: `This is the beginning of "${title}". Add your content here.`,
                    pageNumber: 1
                }];
                books[window.currentBookIndex].chapters.push(chapter);
                saveData();
                updateStats();
                displayBooks();
                if (currentBook && currentBook.id === books[window.currentBookIndex].id) {
                    displayChapterNav();
                    if (currentChapterIndex >= books[window.currentBookIndex].chapters.length - 1) {
                        currentChapterIndex = books[window.currentBookIndex].chapters.length - 1;
                        currentPageIndex = 0;
                        displayCurrentPage();
                    }
                }
                closeAddChapterModal();
                showToast('Chapter added successfully!');
            }
        });

        function splitContentIntoPages(content) {
            const wordsPerPage = 300;
            const words = content.split(/\s+/).filter(word => word.trim());
            const pages = [];
            for (let i = 0; i < words.length; i += wordsPerPage) {
                const pageWords = words.slice(i, i + wordsPerPage);
                pages.push({
                    id: Date.now().toString() + '_' + pages.length,
                    content: pageWords.join(' '),
                    pageNumber: pages.length + 1
                });
            }
            return pages.length > 0 ? pages : [{
                id: Date.now().toString(),
                content: content,
                pageNumber: 1
            }];
        }

        // Book reading
        function openBook(bookIndex) {
            const book = books[bookIndex];
            currentBook = book;
            const progress = readingProgress[book.id] || { currentChapter: 0, currentPage: 0 };
            currentChapterIndex = progress.currentChapter;
            currentPageIndex = progress.currentPage;
            showBookReader();
        }

        function showBookReader() {
            showSection('reader');
            if (!currentBook.chapters || currentBook.chapters.length === 0) {
                currentBook.chapters = [{
                    id: Date.now().toString(),
                    title: 'Introduction',
                    pages: [{
                        id: Date.now().toString(),
                        content: `Welcome to "${currentBook.title}". Add chapters to start reading.`,
                        pageNumber: 1
                    }],
                    createdAt: new Date().toISOString()
                }];
                saveData();
            }
            displayCurrentPage();
            updateReaderControls();
            displayChapterNav();
            displayNotes();
        }

        function goBackToLibrary() {
            showSection('library');
            saveReadingProgress();
        }

        function displayCurrentPage() {
            if (!currentBook || !currentBook.chapters[currentChapterIndex]) {
                return;
            }
            const chapter = currentBook.chapters[currentChapterIndex];
            const page = chapter.pages[currentPageIndex] || chapter.pages[0] || {
                id: Date.now().toString(),
                content: `No content available for "${chapter.title}". Add content to this chapter.`,
                pageNumber: 1
            };
            const bookTitleEl = document.getElementById('book-title');
            const chapterTitleEl = document.getElementById('chapter-title');
            const pageContentEl = document.getElementById('page-content');
            const pageInfoEl = document.getElementById('page-info');
            const progressTextEl = document.getElementById('progress-text');
            const progressBarEl = document.getElementById('progress-bar');

            if (bookTitleEl) bookTitleEl.textContent = currentBook.title;
            if (chapterTitleEl) chapterTitleEl.textContent = chapter.title;
            if (pageContentEl) pageContentEl.innerHTML = `<p>${page.content}</p>`;
            const totalPages = currentBook.chapters.reduce((sum, ch) => sum + ch.pages.length, 0);
            const currentPageNum = currentBook.chapters.slice(0, currentChapterIndex).reduce((sum, ch) => sum + ch.pages.length, 0) + currentPageIndex + 1;
            if (pageInfoEl) pageInfoEl.textContent = `Page ${currentPageNum} of ${totalPages}`;
            const progressPercent = Math.round((currentPageNum / totalPages) * 100);
            if (progressTextEl) progressTextEl.textContent = `${progressPercent}%`;
            if (progressBarEl) progressBarEl.style.width = `${progressPercent}%`;
            const bookPageEl = document.getElementById('book-page');
            if (bookPageEl) {
                bookPageEl.classList.add('page-transition');
                setTimeout(() => {
                    bookPageEl.classList.remove('page-transition');
                }, 600);
            }
            saveReadingProgress();
            updateChapterNav();
            displayNotes();
        }

        function updateReaderControls() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            if (!prevBtn || !nextBtn) return;
            const canGoPrev = currentChapterIndex > 0 || currentPageIndex > 0;
            prevBtn.disabled = !canGoPrev;
            prevBtn.classList.toggle('opacity-50', !canGoPrev);
            const chapter = currentBook.chapters[currentChapterIndex];
            const canGoNext = currentPageIndex < chapter.pages.length - 1 || currentChapterIndex < currentBook.chapters.length - 1;
            nextBtn.disabled = !canGoNext;
            nextBtn.classList.toggle('opacity-50', !canGoNext);
        }

        function displayChapterNav() {
            const chapterNav = document.getElementById('chapter-nav');
            const chapterList = document.getElementById('chapter-list');
            if (!chapterNav || !chapterList || !currentBook) {
                if (chapterNav) chapterNav.classList.add('hidden');
                return;
            }
            chapterNav.classList.remove('hidden');
            chapterList.innerHTML = currentBook.chapters.length > 0 ? currentBook.chapters.map((chapter, index) => `
                <button onclick="jumpToChapter(${index})" class="chapter-nav-item w-full text-left p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${index === currentChapterIndex ? 'active' : ''}">
                    ${index + 1}. ${chapter.title}
                </button>
            `).join('') : `
                <p class="text-sm text-gray-500">No chapters yet. Add a chapter to start reading.</p>
                <button onclick="showAddChapterModal(${books.findIndex(b => b.id === currentBook.id)})" class="mt-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition-colors">
                    <i class="fas fa-plus"></i> Add Chapter
                </button>
            `;
        }

        function jumpToChapter(chapterIndex) {
            currentChapterIndex = chapterIndex;
            currentPageIndex = 0;
            displayCurrentPage();
            updateReaderControls();
        }

        function updateChapterNav() {
            const chapterItems = document.querySelectorAll('.chapter-nav-item');
            chapterItems.forEach((item, index) => {
                item.classList.toggle('active', index === currentChapterIndex);
            });
        }

        function nextPage() {
            if (!currentBook) return;
            const chapter = currentBook.chapters[currentChapterIndex];
            if (currentPageIndex < chapter.pages.length - 1) {
                currentPageIndex++;
            } else if (currentChapterIndex < currentBook.chapters.length - 1) {
                currentChapterIndex++;
                currentPageIndex = 0;
            } else {
                markBookCompleted();
                return;
            }
            displayCurrentPage();
            updateReaderControls();
        }

        function previousPage() {
            if (!currentBook) return;
            if (currentPageIndex > 0) {
                currentPageIndex--;
            } else if (currentChapterIndex > 0) {
                currentChapterIndex--;
                const prevChapter = currentBook.chapters[currentChapterIndex];
                currentPageIndex = prevChapter.pages.length - 1;
            }
            displayCurrentPage();
            updateReaderControls();
        }

        function markBookCompleted() {
            if (!readingProgress[currentBook.id]) {
                readingProgress[currentBook.id] = {};
            }
            readingProgress[currentBook.id].completed = true;
            readingProgress[currentBook.id].completedAt = new Date().toISOString();
            saveData();
            updateStats();
            displayBooks();
            displayContinueReading();
            showToast('Congratulations! You completed this book!', 'success');
        }

        function saveReadingProgress() {
            if (!currentBook) return;
            if (!readingProgress[currentBook.id]) {
                readingProgress[currentBook.id] = {};
            }
            readingProgress[currentBook.id].currentChapter = currentChapterIndex;
            readingProgress[currentBook.id].currentPage = currentPageIndex;
            readingProgress[currentBook.id].lastRead = new Date().toISOString();
            saveData();
            updateStats();
            displayBooks();
            displayContinueReading();
        }

        // Dictionary and Notes
        function searchDictionary() {
            const input = document.getElementById('dictionary-input');
            if (!input) return;
            const word = input.value.trim();
            if (!word) {
                showToast('Please enter a word to search', 'error');
                return;
            }
            getDefinition(word).then(definition => {
                const results = document.getElementById('dictionary-results');
                if (results) {
                    results.innerHTML = definition ? `
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded">
                            <h4 class="font-semibold">${word}</h4>
                            <p class="text-sm">${definition}</p>
                        </div>
                    ` : `
                        <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded">
                            <p class="text-sm text-gray-500">No definition found for "${word}"</p>
                        </div>
                    `;
                }
            });
        }

        async function getDefinition(word) {
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const meanings = data[0].meanings.map(meaning => {
                        return meaning.definitions[0].definition;
                    }).join('; ');
                    return meanings;
                } else {
                    return null;
                }
            } catch (err) {
                showToast('Failed to fetch definition', 'error');
                return null;
            }
        }

        function saveReaderNote() {
            if (!currentBook || !currentBook.chapters[currentChapterIndex] || !currentBook.chapters[currentChapterIndex].pages[currentPageIndex]) {
                showToast('No book, chapter, or page selected', 'error');
                return;
            }
            const input = document.getElementById('reader-note-input');
            if (!input) return;
            const content = input.value.trim();
            if (!content) {
                showToast('Please enter a note', 'error');
                return;
            }
            const note = {
                id: Date.now().toString(),
                type: 'text',
                content: content,
                bookId: currentBook.id,
                chapterId: currentBook.chapters[currentChapterIndex].id,
                pageId: currentBook.chapters[currentChapterIndex].pages[currentPageIndex].id,
                timestamp: new Date().toISOString()
            };
            notes.push(note);
            saveData();
            input.value = '';
            displayNotes();
            showToast('Note saved!');
        }

        function displayNotes() {
            const notesList = document.getElementById('notes-list');
            const audioNotesList = document.getElementById('audio-notes-list');
            if (!notesList || !audioNotesList || !currentBook) return;
            const relevantNotes = notes.filter(note => note.bookId === currentBook.id);
            const textNotes = relevantNotes.filter(note => note.type === 'text');
            const audioNotes = relevantNotes.filter(note => note.type === 'audio');
            notesList.innerHTML = textNotes.length > 0 ? textNotes.map(note => `
                <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm">
                    <p>${note.content}</p>
                    <p class="text-xs text-gray-500">Page ${getPageNumber(note.pageId)} - ${new Date(note.timestamp).toLocaleString()}</p>
                </div>
            `).join('') : '<p class="text-sm text-gray-500">No text notes yet</p>';
            audioNotesList.innerHTML = audioNotes.length > 0 ? audioNotes.map(note => `
                <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm flex items-center space-x-2">
                    <button onclick="playAudioNote('${note.content}')" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs">
                        <i class="fas fa-play"></i>
                    </button>
                    <p class="text-xs text-gray-500 flex-1">Page ${getPageNumber(note.pageId)} - ${new Date(note.timestamp).toLocaleString()}</p>
                </div>
            `).join('') : '<p class="text-sm text-gray-500">No audio notes yet</p>';
        }

        function getPageNumber(pageId) {
            if (!currentBook) return 'Unknown';
            for (let chapter of currentBook.chapters) {
                const page = chapter.pages.find(p => p.id === pageId);
                if (page) return page.pageNumber;
            }
            return 'Unknown';
        }

        function playAudioNote(audioData) {
            try {
                const audio = new Audio(audioData);
                audio.play();
            } catch (err) {
                showToast('Failed to play audio note', 'error');
            }
        }

        // Recording functionality
        function checkMediaRecorderSupport() {
            const recordBtn = document.getElementById('note-record-btn');
            const status = document.getElementById('note-recording-status');
            if (!navigator.mediaDevices || !window.MediaRecorder) {
                if (recordBtn) recordBtn.disabled = true;
                if (status) status.textContent = 'Recording not supported';
                return false;
            }
            return true;
        }

        function toggleNoteRecording() {
            if (!checkMediaRecorderSupport()) {
                showToast('Audio recording not supported in this browser', 'error');
                return;
            }
            if (!currentBook || !currentBook.chapters[currentChapterIndex] || !currentBook.chapters[currentChapterIndex].pages[currentPageIndex]) {
                showToast('No book, chapter, or page selected', 'error');
                return;
            }
            if (isNoteRecording) {
                stopNoteRecording();
            } else {
                startNoteRecording();
            }
        }

        async function startNoteRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };
                mediaRecorder.onstop = showSaveNoteRecordingModal;
                mediaRecorder.start();
                isNoteRecording = true;
                const recordBtn = document.getElementById('note-record-btn');
                const status = document.getElementById('note-recording-status');
                if (recordBtn) recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                if (status) status.textContent = 'Recording...';
            } catch (err) {
                showToast('Failed to access microphone', 'error');
            }
        }

        function stopNoteRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isNoteRecording = false;
                const recordBtn = document.getElementById('note-record-btn');
                const status = document.getElementById('note-recording-status');
                if (recordBtn) recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                if (status) status.textContent = '';
            }
        }

        function showSaveNoteRecordingModal() {
            const modal = document.getElementById('save-note-recording-modal');
            recordedAudioData = new Blob(recordedChunks, { type: 'audio/webm' });
            if (modal) modal.classList.remove('hidden');
        }

        function closeSaveNoteRecordingModal() {
            const modal = document.getElementById('save-note-recording-modal');
            if (modal) modal.classList.add('hidden');
            recordedAudioData = null;
        }

        document.getElementById('save-note-recording-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!currentBook || !currentBook.chapters[currentChapterIndex] || !currentBook.chapters[currentChapterIndex].pages[currentPageIndex]) {
                showToast('No book, chapter, or page selected', 'error');
                return;
            }
            const reader = new FileReader();
            reader.onload = function() {
                const note = {
                    id: Date.now().toString(),
                    type: 'audio',
                    content: reader.result,
                    bookId: currentBook.id,
                    chapterId: currentBook.chapters[currentChapterIndex].id,
                    pageId: currentBook.chapters[currentChapterIndex].pages[currentPageIndex].id,
                    timestamp: new Date().toISOString()
                };
                notes.push(note);
                saveData();
                displayNotes();
                closeSaveNoteRecordingModal();
                showToast('Audio note saved!');
            };
            reader.readAsDataURL(recordedAudioData);
        });

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('nizebook_books', JSON.stringify(books));
            localStorage.setItem('nizebook_uploaded_audiobooks', JSON.stringify(uploadedAudiobooks));
            localStorage.setItem('nizebook_progress', JSON.stringify(readingProgress));
            localStorage.setItem('nizebook_notes', JSON.stringify(notes));
        }

        // Initialize the app
        initializeApp();
    </script>
</body>
</html>